name: Test Ubicloud Prod Runners

on:
  push:
    branches: [enes/minio-benchmark]

env:
  MC_HOST_ubicloud: ${{ secrets.MINIO_CONNECTION_STRING }}
jobs:
  upload:
    runs-on: ubicloud-standard-8
    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: Install MinIO client
        run: |
          curl https://dl.min.io/client/mc/release/linux-amd64/mc -o mc
          sudo mv mc /usr/bin/mc
          sudo chmod +x /usr/bin/mc
          mc --version

      - name: Set MinIO root certificates
        run: |
          mkdir -p ~/.mc/certs/CAs
          cat <<EOT > ~/.mc/certs/CAs/ubicloud_images_blob_storage_certs.crt
          ${{ secrets.MINIO_ROOT_CERTIFICATES }}
          EOT

      - name: Download Hetzner 1GB test file
        run: curl -O https://fsn1-speed.hetzner.com/1GB.bin

      - name: Upload file to MinIO
        run: |
          mc cp --json ./1GB.bin ubicloud/ubicloud-cache/1GB-${{ github.run_id }}.bin \
            | tail -n 1 \
            | jq '.speed' \
            | awk '{printf "%.2f\n", $1 / 1024 / 1024}' >> $GITHUB_STEP_SUMMARY

  restore:
    needs: upload
    strategy:
      max-parallel: 8
      fail-fast: false
      matrix:
        runs-on:
          - ubicloud-standard-8 # 1
          - ubicloud-standard-8 # 2
          - ubicloud-standard-8 # 3
          - ubicloud-standard-8 # 4
          - ubicloud-standard-8 # 5
          - ubicloud-standard-8 # 6
          - ubicloud-standard-8 # 7
          - ubicloud-standard-8 # 8
          - ubicloud-standard-8 # 9
          - ubicloud-standard-8 # 10
          - ubicloud-standard-8 # 11
          - ubicloud-standard-8 # 12
          - ubicloud-standard-8 # 13
          - ubicloud-standard-8 # 14
          - ubicloud-standard-8 # 15
          - ubicloud-standard-8 # 16
    runs-on: ${{ matrix.runs-on }}
    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: Install MinIO client
        run: |
          curl https://dl.min.io/client/mc/release/linux-amd64/mc -o mc
          sudo mv mc /usr/bin/mc
          sudo chmod +x /usr/bin/mc
          mc --version

      - name: Set MinIO root certificates
        run: |
          mkdir -p ~/.mc/certs/CAs
          cat <<EOT > ~/.mc/certs/CAs/ubicloud_images_blob_storage_certs.crt
          ${{ secrets.MINIO_ROOT_CERTIFICATES }}
          EOT

      - name: Download file from MinIO
        run: |
          mc cp --json ubicloud/ubicloud-cache/1GB-${{ github.run_id }}.bin ./1GB.bin \
            | tail -n 1 \
            | jq '.speed' \
            | awk '{printf "%.2f\n", $1 / 1024 / 1024}' >> $GITHUB_STEP_SUMMARY
