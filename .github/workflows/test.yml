name: Test Ubicloud Prod Runners

on:
  push:
    branches: [check-dnsmasq]

jobs:
  test:
    name: runner ${{ matrix.index }}
    strategy:
      # max-parallel: 1
      matrix:
        index: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50]
    runs-on: ubicloud
    steps:
      - name: checkout
        uses: actions/checkout@v4

      - name: Print kernel version
        run: uname -mr

      - name: Print OS version
        run: lsb_release -a

      - name: Print environment variables
        run: printenv

      - name: Print PATH
        run: echo $PATH

      - name: Verify that has more than 100 environment variables
        run: |
          count=$(env | wc -l)
          if [ "$count" -lt 100 ]; then
            echo "Environment has $count variables, expected at least 100"
            exit 1
          fi

      - name: Try to update apt-get
        run: sudo apt-get update

      - name: Check filesystem
        run: sudo fsck -nf || [ $? -eq 4 ]

      - name: docker info
        run: docker info

      - name: ip a
        run: ip a

      - name: resolvectl status
        run: resolvectl status

      - name: Vm IPv4
        run: ping -4 -c 2 google.com

      - name: Vm IPv6
        run: ping -6 -c 2 google.com

      - name: Check docker internet connectivity
        run: docker run alpine ping -c 2 google.com

      - name: Docker IPv4
        run: docker run alpine ping -4 -c 2 google.com
